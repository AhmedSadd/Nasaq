# Simulation Lab Implementation Plan

## Goal Description
Create a "Simulation Lab" to backtest specific strategy configurations with high precision. The system will parse user input strings, simulate trades using historical data, store detailed trade logs in the database, and present a dynamic, professional dashboard for analysis.

## User Review Required
> [!IMPORTANT]
> **Simulation Engine:** The detailed simulation will run on the **CPU** using Numba. This is extremely fast for specific configurations (milliseconds per symbol) and allows for precise, detailed trade logging (Entry/Exit times, prices, reasons) which is difficult to extract efficiently from the GPU kernel used for mass scanning.

## Proposed Changes

### Database Schema ([core/db_manager.py](file:///c:/Aa_MyFiles/Coding/bybit_scanner/strategy_tester/TradingBot/core/db_manager.py))
#### [MODIFY] [core/db_manager.py](file:///c:/Aa_MyFiles/Coding/bybit_scanner/strategy_tester/TradingBot/core/db_manager.py)
- Add `simulation_sessions` table:
    - `session_id` (TEXT, PK)
    - `created_at` (DATETIME)
    - `config_text` (TEXT)
    - `start_date` (TEXT)
    - `end_date` (TEXT)
    - `timeframe` (TEXT)
- Add `simulation_trades` table:
    - `trade_id` (INTEGER, PK)
    - `session_id` (TEXT, FK)
    - [symbol](file:///c:/Aa_MyFiles/Coding/bybit_scanner/strategy_tester/TradingBot/core/data_loader.py#211-230) (TEXT)
    - `strategy` (TEXT)
    - [params](file:///c:/Aa_MyFiles/Coding/bybit_scanner/strategy_tester/TradingBot/strategies/acvs.py#196-229) (TEXT - JSON)
    - `entry_time` (DATETIME)
    - `entry_price` (REAL)
    - `exit_time` (DATETIME)
    - `exit_price` (REAL)
    - `direction` (TEXT)
    - `stop_loss` (REAL)
    - `take_profit` (REAL)
    - `r_multiple` (REAL)
    - `exit_reason` (TEXT)

### Strategy Logic ([strategies/acvs.py](file:///c:/Aa_MyFiles/Coding/bybit_scanner/strategy_tester/TradingBot/strategies/acvs.py))
#### [MODIFY] [strategies/acvs.py](file:///c:/Aa_MyFiles/Coding/bybit_scanner/strategy_tester/TradingBot/strategies/acvs.py)
- Add `backtest_detailed` method (CPU Numba) to return a list of individual trades with all details (Entry, Exit, SL, TP, R-Multiple).

### Simulation Engine (`core/simulation_engine.py`)
#### [NEW] `core/simulation_engine.py`
- `parse_config(text)`: Regex parser for `EXCHANGE:SYMBOLðŸ¤–STRATEGY (PARAMS)*` format.
- [run_simulation(session_id, config_text, start_date, end_date)](file:///c:/Aa_MyFiles/Coding/bybit_scanner/strategy_tester/TradingBot/runners/run_simulation.py#5-19):
    - Orchestrates data loading/downloading.
    - Runs `backtest_detailed` for each config.
    - Saves trades to `simulation_trades`.

### User Interface ([ui/simulation_page.py](file:///c:/Aa_MyFiles/Coding/bybit_scanner/strategy_tester/TradingBot/ui/simulation_page.py))
#### [MODIFY] [ui/simulation_page.py](file:///c:/Aa_MyFiles/Coding/bybit_scanner/strategy_tester/TradingBot/ui/simulation_page.py)
- **Input Section:**
    - Text Area for Config String.
    - Date Range Pickers.
    - Timeframe Selector.
    - "Run Simulation" Button.
- **Results Dashboard (The "Viewer"):**
    - **Sidebar Controls:** Initial Capital, Risk %, Commission %.
    - **Dynamic Calculations:** Re-calculate Portfolio Equity based on stored `r_multiple` and user controls.
    - **Visuals:**
        - Key Metrics (Net Profit, Win Rate, Max DD, Sharpe, Profit Factor).
        - Interactive Equity Curve (Plotly).
        - Monthly Returns Heatmap.
        - Trade List Table (Sortable/Filterable).
    - **Export:** "Copy Config" button.

## Verification Plan
### Automated Tests
- Unit test for `parse_config` regex.
- Unit test for `backtest_detailed` logic (verify trade count matches scan results).

### Manual Verification
- Run a simulation with the user's example string.
- Verify trades are saved to DB.
- Verify Dashboard updates dynamically when Risk % is changed.
- Compare results with "Manual Test" CSV if available.
